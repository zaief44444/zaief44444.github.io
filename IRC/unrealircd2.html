<!DOCTYPE html>
<html>
<head>
<title>UnrealIRCd解説</title>
<meta http-equive="content-type" charset="utf-8">
<link rel="icon" href="/img/favicon.ico">
<link rel="stylesheet" href="/css/simple.css">
</head>
<body>
<p><a href="../">戻る</a>
<h1>UnrealIRCd解説</h1>
<p> July 11, 2020
<p> 今の時代にIRCサーバーを立てたとしても, 少なくともネット上では活用できないだろう. 今はSNSの時代でありそれで多くの人は事足りる. チャットはDiscordが盛んでIRCよりも格段に便利なのでそこへ移転するコミュニティも多かった. つまり自己満足でやることであり, ユーザーが来ることは期待するものではない. 今回もArchの環境でやっている. 
<p> pacman -S unrealircd とすると, unrealircd関係のファイルが以下のように入る. 
<pre>
<code>
/etc/unrealircd
/etc/unrealircd/examples
/etc/unrealircd/examples/example.conf
/etc/unrealircd/examples/example.tr.conf
/etc/unrealircd/examples/example.fr.conf
/etc/unrealircd/operclass.default.conf
/etc/unrealircd/unrealircd
/etc/unrealircd/help
/etc/unrealircd/help/help.tr.conf
/etc/unrealircd/help/help.de.conf
/etc/unrealircd/help/help.fr.conf
/etc/unrealircd/help/help.it.conf
/etc/unrealircd/help/help.conf
/etc/unrealircd/help/help.ru.conf
/etc/unrealircd/dccallow.conf
/etc/unrealircd/aliases
/etc/unrealircd/aliases/epona.conf
/etc/unrealircd/aliases/ircservices.conf
/etc/unrealircd/aliases/auspice.conf
/etc/unrealircd/aliases/generic.conf
/etc/unrealircd/aliases/atheme.conf
/etc/unrealircd/aliases/operstats.conf
/etc/unrealircd/aliases/aliases.conf
/etc/unrealircd/aliases/cygnus.conf
/etc/unrealircd/aliases/anope.conf
/etc/unrealircd/aliases/genericstats.conf
/etc/unrealircd/modules.sources.list
/etc/unrealircd/badwords.conf
/etc/unrealircd/tls
/etc/unrealircd/tls/curl-ca-bundle.crt
/etc/unrealircd/unrealircd.conf
/etc/unrealircd/modules.default.conf
/etc/unrealircd/modules.optional.conf
/etc/unrealircd/spamfilter.conf
/run/unrealircd
/usr/share/doc/unrealircd
/usr/share/doc/unrealircd/coding-guidelines
/usr/share/doc/unrealircd/Authors
/usr/share/doc/unrealircd/tao.of.irc
/usr/lib/sysusers.d/unrealircd.conf
/usr/lib/unrealircd
/usr/lib/unrealircd/certfp.so
/usr/lib/unrealircd/jointhrottle.so
/usr/lib/unrealircd/restrict-commands.so
/usr/lib/unrealircd/away.so
/usr/lib/unrealircd/topic.so
/usr/lib/unrealircd/svsmode.so
/usr/lib/unrealircd/batch.so
/usr/lib/unrealircd/sajoin.so
/usr/lib/unrealircd/blacklist.so
/usr/lib/unrealircd/names.so
/usr/lib/unrealircd/stats.so
/usr/lib/unrealircd/link-security.so
/usr/lib/unrealircd/sjoin.so
/usr/lib/unrealircd/time.so
/usr/lib/unrealircd/quit.so
/usr/lib/unrealircd/dccallow.so
/usr/lib/unrealircd/svsnline.so
/usr/lib/unrealircd/sendsno.so
/usr/lib/unrealircd/user.so
/usr/lib/unrealircd/admin.so
/usr/lib/unrealircd/connthrottle.so
/usr/lib/unrealircd/echo-message.so
/usr/lib/unrealircd/lusers.so
/usr/lib/unrealircd/svsmotd.so
/usr/lib/unrealircd/webredir.so
/usr/lib/unrealircd/starttls.so
/usr/lib/unrealircd/list.so
/usr/lib/unrealircd/message.so
/usr/lib/unrealircd/tsctl.so
/usr/lib/unrealircd/tkldb.so
/usr/lib/unrealircd/history.so
/usr/lib/unrealircd/snomasks
/usr/lib/unrealircd/snomasks/dccreject.so
/usr/lib/unrealircd/history_backend_null.so
/usr/lib/unrealircd/staff.so
/usr/lib/unrealircd/chgident.so
/usr/lib/unrealircd/plaintext-policy.so
/usr/lib/unrealircd/userip-tag.so
/usr/lib/unrealircd/cap.so
/usr/lib/unrealircd/account-notify.so
/usr/lib/unrealircd/mode.so
/usr/lib/unrealircd/websocket.so
/usr/lib/unrealircd/part.so
/usr/lib/unrealircd/third
/usr/lib/unrealircd/chanmodes
/usr/lib/unrealircd/chanmodes/floodprot.so
/usr/lib/unrealircd/chanmodes/operonly.so
/usr/lib/unrealircd/chanmodes/issecure.so
/usr/lib/unrealircd/chanmodes/censor.so
/usr/lib/unrealircd/chanmodes/nokick.so
/usr/lib/unrealircd/chanmodes/noknock.so
/usr/lib/unrealircd/chanmodes/history.so
/usr/lib/unrealircd/chanmodes/nocolor.so
/usr/lib/unrealircd/chanmodes/regonly.so
/usr/lib/unrealircd/chanmodes/link.so
/usr/lib/unrealircd/chanmodes/delayjoin.so
/usr/lib/unrealircd/chanmodes/stripcolor.so
/usr/lib/unrealircd/chanmodes/secureonly.so
/usr/lib/unrealircd/chanmodes/noctcp.so
/usr/lib/unrealircd/chanmodes/regonlyspeak.so
/usr/lib/unrealircd/chanmodes/noinvite.so
/usr/lib/unrealircd/chanmodes/nonickchange.so
/usr/lib/unrealircd/chanmodes/permanent.so
/usr/lib/unrealircd/chanmodes/nonotice.so
/usr/lib/unrealircd/eos.so
/usr/lib/unrealircd/usermodes
/usr/lib/unrealircd/usermodes/privacy.so
/usr/lib/unrealircd/usermodes/censor.so
/usr/lib/unrealircd/usermodes/secureonlymsg.so
/usr/lib/unrealircd/usermodes/nokick.so
/usr/lib/unrealircd/usermodes/privdeaf.so
/usr/lib/unrealircd/usermodes/bot.so
/usr/lib/unrealircd/usermodes/showwhois.so
/usr/lib/unrealircd/usermodes/servicebot.so
/usr/lib/unrealircd/usermodes/noctcp.so
/usr/lib/unrealircd/usermodes/regonlymsg.so
/usr/lib/unrealircd/lag.so
/usr/lib/unrealircd/setname.so
/usr/lib/unrealircd/whois.so
/usr/lib/unrealircd/sinfo.so
/usr/lib/unrealircd/svsjoin.so
/usr/lib/unrealircd/cycle.so
/usr/lib/unrealircd/svssilence.so
/usr/lib/unrealircd/addmotd.so
/usr/lib/unrealircd/sts.so
/usr/lib/unrealircd/kick.so
/usr/lib/unrealircd/connect.so
/usr/lib/unrealircd/ison.so
/usr/lib/unrealircd/userip.so
/usr/lib/unrealircd/tkl.so
/usr/lib/unrealircd/sqline.so
/usr/lib/unrealircd/trace.so
/usr/lib/unrealircd/userhost.so
/usr/lib/unrealircd/map.so
/usr/lib/unrealircd/botmotd.so
/usr/lib/unrealircd/protoctl.so
/usr/lib/unrealircd/svslusers.so
/usr/lib/unrealircd/rules.so
/usr/lib/unrealircd/unsqline.so
/usr/lib/unrealircd/whowas.so
/usr/lib/unrealircd/jumpserver.so
/usr/lib/unrealircd/cloak.so
/usr/lib/unrealircd/dccdeny.so
/usr/lib/unrealircd/umode2.so
/usr/lib/unrealircd/vhost.so
/usr/lib/unrealircd/md.so
/usr/lib/unrealircd/nocodes.so
/usr/lib/unrealircd/antimixedutf8.so
/usr/lib/unrealircd/userhost-tag.so
/usr/lib/unrealircd/svswatch.so
/usr/lib/unrealircd/sdesc.so
/usr/lib/unrealircd/ircops.so
/usr/lib/unrealircd/rmtkl.so
/usr/lib/unrealircd/chghost.so
/usr/lib/unrealircd/extbans
/usr/lib/unrealircd/extbans/certfp.so
/usr/lib/unrealircd/extbans/realname.so
/usr/lib/unrealircd/extbans/msgbypass.so
/usr/lib/unrealircd/extbans/partmsg.so
/usr/lib/unrealircd/extbans/quiet.so
/usr/lib/unrealircd/extbans/account.so
/usr/lib/unrealircd/extbans/operclass.so
/usr/lib/unrealircd/extbans/textban.so
/usr/lib/unrealircd/extbans/timedban.so
/usr/lib/unrealircd/extbans/nickchange.so
/usr/lib/unrealircd/extbans/inchannel.so
/usr/lib/unrealircd/extbans/join.so
/usr/lib/unrealircd/sapart.so
/usr/lib/unrealircd/channeldb.so
/usr/lib/unrealircd/pingpong.so
/usr/lib/unrealircd/chgname.so
/usr/lib/unrealircd/pass.so
/usr/lib/unrealircd/webirc.so
/usr/lib/unrealircd/authprompt.so
/usr/lib/unrealircd/svskill.so
/usr/lib/unrealircd/nick.so
/usr/lib/unrealircd/reputation.so
/usr/lib/unrealircd/message-tags.so
/usr/lib/unrealircd/setident.so
/usr/lib/unrealircd/knock.so
/usr/lib/unrealircd/wallops.so
/usr/lib/unrealircd/locops.so
/usr/lib/unrealircd/charsys.so
/usr/lib/unrealircd/whox.so
/usr/lib/unrealircd/history_backend_mem.so
/usr/lib/unrealircd/sethost.so
/usr/lib/unrealircd/ident_lookup.so
/usr/lib/unrealircd/oper.so
/usr/lib/unrealircd/swhois.so
/usr/lib/unrealircd/tls_antidos.so
/usr/lib/unrealircd/mkpasswd.so
/usr/lib/unrealircd/sendumode.so
/usr/lib/unrealircd/kill.so
/usr/lib/unrealircd/addomotd.so
/usr/lib/unrealircd/who_old.so
/usr/lib/unrealircd/require-module.so
/usr/lib/unrealircd/labeled-response.so
/usr/lib/unrealircd/message-ids.so
/usr/lib/unrealircd/join.so
/usr/lib/unrealircd/watch.so
/usr/lib/unrealircd/hideserver.so
/usr/lib/unrealircd/silence.so
/usr/lib/unrealircd/svsnoop.so
/usr/lib/unrealircd/samode.so
/usr/lib/unrealircd/close.so
/usr/lib/unrealircd/svspart.so
/usr/lib/unrealircd/help.so
/usr/lib/unrealircd/svssno.so
/usr/lib/unrealircd/opermotd.so
/usr/lib/unrealircd/netinfo.so
/usr/lib/unrealircd/server.so
/usr/lib/unrealircd/invite.so
/usr/lib/unrealircd/sasl.so
/usr/lib/unrealircd/squit.so
/usr/lib/unrealircd/motd.so
/usr/lib/unrealircd/globops.so
/usr/lib/unrealircd/server-time.so
/usr/lib/unrealircd/svsnick.so
/usr/lib/unrealircd/account-tag.so
/usr/lib/unrealircd/svsnolag.so
/usr/lib/unrealircd/antirandom.so
/usr/lib/unrealircd/links.so
/usr/lib/systemd/system/unrealircd.service
/usr/lib/tmpfiles.d/unrealircd.conf
/usr/bin/unrealircd
/var/cache/unrealircd
/var/cache/pacman/pkg/unrealircd-5.0.3.1-1-x86_64.pkg.tar.zst
/var/lib/unrealircd
/var/lib/pacman/local/unrealircd-5.0.3.1-1
/var/lib/pacman/local/unrealircd-5.0.3.1-1/mtree
/var/lib/pacman/local/unrealircd-5.0.3.1-1/install
/var/lib/pacman/local/unrealircd-5.0.3.1-1/files
/var/lib/pacman/local/unrealircd-5.0.3.1-1/desc
/var/log/unrealircd
</code>
</pre>
<p> この中からいくつか抜粋してみる. /usr/share/ はドキュメント類を入れたりするのに使われるが, unrealircdの場合はあまり有用な情報がなかったりする.
<pre>
<code>
/usr/share/doc/unrealircd
/usr/share/doc/unrealircd/coding-guidelines
/usr/share/doc/unrealircd/Authors
/usr/share/doc/unrealircd/tao.of.irc
</code>
</pre>
<p> unrealircdは, confファイルをいじることから始まる. confファイルと言っても色々あるが, メインのconfファイルが様々なconfファイルをincludeする. confファイルはArchの場合 /etc/unrealircd/ に置いてある. 
多くのモジュールがmodules.default.confにリストされincludeで導入できる.
<pre>
<code>
include "modules.default.conf";
include "help/help.conf";
include "badwords.conf";
// include "spamfilter.conf";
include "operclass.default.conf";
</code>
</pre>

<p> modules.default.confを覗いてみる. 一部抜粋で, 
<pre>
<code>


</code>
</pre>
<p> 寄り道, というかsystemdとシェルスクリプトの理解のためにメモ. 
<pre>
<code>
#!/bin/sh

PID_FILE="/run/unrealircd/ircd.pid"
PID_BACKUP="/run/unrealircd/ircd.pid.bak"
if [ ! -f /usr/bin/unrealircd ]; then
	echo "ERROR: Could not find the IRCd binary (/usr/bin/unrealircd)"
	echo "This could mean two things:"
	echo "1) You forgot to run 'make install' after running 'make'"
	echo "2) You answered a ./Config question incorrectly"
	exit
fi
if [ "$1" = "start" ] ; then
	echo "Starting UnrealIRCd"
	if [ -r $PID_FILE ] ; then
		mv -f $PID_FILE $PID_BACKUP
	fi
	# When built with --with-asan, ASan does not dump core by default because
	# older gcc/clang might dump a 16TB core file. We explicitly enable it here.
	export ASAN_OPTIONS="abort_on_error=1:disable_coredump=0:unmap_shadow_on_exit=1:log_path=/tmp/unrealircd_asan:detect_leaks=0"

	# Check if ~/Unrealxxx/unrealircd.conf exists but the file
	# ~/unrealircd/conf/unrealircd.conf does not.
	# If so, then assume a user-build and give the user a nice hint...
	if [ ! -f /etc/unrealircd/unrealircd.conf -a -f /build/unrealircd/src/unrealircd-5.0.3.1/unrealircd.conf ]; then
		echo ""
		echo "There is no unrealircd.conf in /etc/unrealircd"
		echo "However I did find an unrealircd.conf in /build/unrealircd/src/unrealircd-5.0.3.1"
		echo "With UnrealIRCd 4 you should no longer run the IRCd from /build/unrealircd/src/unrealircd-5.0.3.1."
		echo "You should 'cd /usr' and work from there."
		echo "See https://www.unrealircd.org/docs/UnrealIRCd_files_and_directories"
		exit 1
	fi
	if [ ! -f /etc/unrealircd/unrealircd.conf ]; then
		echo ""
		echo "The configuration file does not exist (/etc/unrealircd/unrealircd.conf)."
		echo "* Create one by following:"
		echo "  https://www.unrealircd.org/docs/Installing_from_source#Creating_a_configuration_file"
		echo "* Or if you are upgrading from version 3.2.x then read:"
		echo "  https://www.unrealircd.org/docs/Upgrading_from_3.2.x and"
		echo "  https://www.unrealircd.org/docs/UnrealIRCd_files_and_directories"
		exit 1
	fi
	/usr/bin/unrealircd
	if [ $? -ne 0 ] ; then
		echo "====================================================="
		echo "UnrealIRCd failed to start. Check above for possible errors."
		echo "If you don't understand the problem, then have a look at our:"
		echo "* FAQ (Frequently Asked Questions): https://www.unrealircd.org/docs/FAQ"
		echo "* Documentation: https://www.unrealircd.org/docs/"
		echo "====================================================="
		if [ -r $PID_BACKUP ] ; then
			mv -f $PID_BACKUP $PID_FILE
		fi
		exit 1
	fi
	# Now check if we need to create a crash report.
	/usr/bin/unrealircd -R
elif [ "$1" = "stop" ] ; then
	echo "Stopping UnrealIRCd"
	if [ ! -r $PID_FILE ] ; then
		echo "ERROR: UnrealIRCd is not running"
		exit 1
	fi
	kill -15 `cat $PID_FILE`
	if [ "$?" != 0 ]; then
		echo "ERROR: UnrealIRCd is not running"
		exit 1
	fi
	sleep 1
	if [ -r $PID_FILE ] ; then
		kill -9 `cat $PID_FILE` 1&gt/dev/null 2&gt&1
	fi
elif [ "$1" = "rehash" ] ; then
	echo "Rehashing UnrealIRCd"
	if [ ! -r $PID_FILE ] ; then
		echo "ERROR: UnrealIRCd is not running"
		exit 1
	fi
	kill -1 `cat $PID_FILE`
	if [ "$?" != 0 ]; then
		echo "ERROR: UnrealIRCd is not running"
		exit 1
	fi
elif [ "$1" = "restart" ] ; then
	echo "Restarting UnrealIRCd"
	if [ ! -r $PID_FILE ] ; then
		echo "WARNING: UnrealIRCd was not running"
	else
		kill -15 `cat $PID_FILE`
		if [ "$?" != 0 ]; then
			echo "WARNING: UnrealIRCd was not running"
		else
			sleep 1
			kill -9 `cat $PID_FILE` 1&gt/dev/null 2&gt&1
		fi
	fi
	$0 start
elif [ "$1" = "croncheck" ] ; then
	if [ -r $PID_FILE ] ; then
		kill -CHLD `cat $PID_FILE` 1&gt/dev/null 2&gt&1
		if [ "$?" = 0 ]; then
			# IRCd is running, bail out silently.
			exit 0
		fi
	fi
	# PID file not found or found but stale
	echo "UnrealIRCd is not running. Starting now..."
	$0 start
elif [ "$1" = "configtest" ] ; then
	/usr/bin/unrealircd -c
elif [ "$1" = "module" ] ; then
	shift
	/usr/bin/unrealircd -m $*
elif [ "$1" = "reloadtls" ] ; then
	echo "Reloading SSL/TLS certificates"
	if [ ! -r $PID_FILE ] ; then
		echo "ERROR: UnrealIRCd is not running"
		exit 1
	fi
	kill -USR1 `cat $PID_FILE`
	if [ "$?" != 0 ]; then
		echo "ERROR: UnrealIRCd is not running"
		exit 1
	fi
elif [ "$1" = "mkpasswd" ] ; then
	/usr/bin/unrealircd -P $2 $3
elif [ "$1" = "version" ] ; then
	/usr/bin/unrealircd -v
elif [ "$1" = "gencloak" ] ; then
	/usr/bin/unrealircd -k
elif [ "$1" = "upgrade-conf" ] ; then
	/usr/bin/unrealircd -U
elif [ "$1" = "backtrace" ] ; then
	cd /tmp

	modpath="/usr/lib/unrealircd"

	# Find the corefile
	echo "Core files available:"
	n="0"
	for i in `echo *core*`
	do
		ls -l $i
		n=`expr $n + 1`
	done

	if [ "$n" -gt 1 ]; then
		echo "Type the name of the core file you want to research:"
		read corefile
	elif [ "$i" = "*core*" -o "$n" -eq 0 ]; then
		echo 'No core files found... Nothing to do'
		echo ''
		echo 'If you are sure UnrealIRCd crashed, then verify that unreal'
		echo 'has permission to dump core (type "ulimit -c unlimited" and see'
		echo 'if you get permission denied errors). Also verify that you did'
		echo 'not run out of quota.'
		echo 'If all that is ok, then it might be that UnrealIRCd did not crash but'
		echo 'got killed by the OS (eg: cpu/mem resource limits), the syadmin,'
		echo 'or an automated process.'
		exit 1
	else
		corefile="$i"
	fi

	if [ ! -f "$corefile" ]; then
		echo "Core file '$corefile' not found"
	fi
	if [ ! -s "$corefile" ]; then
		echo 'Seems the corefile is 0 bytes'
		echo 'This usually means you need to relax the core file resource limit'
		echo '(type "ulimit -c unlimited"), or you might have ran out of quota.'
		exit 1
	fi

	# This is needed for the script below and is probably also helpful for the
	# bug report since you usually want to paste this to the development team.
	export LANG=C
	export LC_ALL=C

	# The tmp/*.so files are often already deleted. Here we have some
	# (ugly) scripting to recreate the tmp/*.so links to the modules *.so files...
	echo 'info sharedlibrary'|gdb /usr/bin/unrealircd $corefile 2&gt/dev/null|\
	grep No|grep tmp/|awk '{ print $2 }'|\
	awk -F '.' "{ system(\"[ -f $modpath/\" \$2 \"/\" \$3 \".so ] && ln -s $modpath/\" \$2 \"/\" \$3 \".so \" \$0 \" || ln -s $modpath/\" \$2 \".so \" \$0) }"
	
	echo ""
	echo "=================== START HERE ======================"
	echo "BACKTRACE:"

cat &gt/tmp/gdb.commands &lt&lt __EOF__
bt
echo \n
frame
echo \n
x/s backupbuf
echo \n
bt 3 full
quit
__EOF__

	gdb -batch -x /tmp/gdb.commands /usr/bin/unrealircd $corefile
	rm -f /tmp/gdb.commands
	echo "GCC: `gcc -v 2&gt&1|tail -n 1`"
	echo "UNAME: `uname -a`"
	echo "UNREAL: `$0 version`"
	echo "CORE: `ls -al $corefile`"
	echo "===================  STOP HERE ======================"
	echo ""
	echo "Copy the parts between the START HERE and STOP HERE marker"
	echo "and report it on https://bugs.unrealircd.org/"
	echo ""
	echo 'But before you do, note the following:'
	echo '1. We do not support modifications of any unrealircd code'
	echo '   (except for config.h changes).'
	echo '2. If you are using 3rd party modules we might request you'
	echo '   to run without them and verify you still crash. This is'
	echo '   to eleminate any loss of time due to bugs made by others'
	echo '3. Always use the latest UnrealIRCd version, we fix (crash)bugs'
	echo '   all the time so your bug might as well be fixed already.'
	echo ""
	echo "Thanks!"
elif [ "$1" = "spki" -o "$1" = "spkifp" ] ; then
	CERT="/etc/unrealircd/tls/server.cert.pem"
	if [ "$2" != "" ]; then
		CERT="$2"
	fi
	if [ ! -f "$CERT" ]; then
		echo "Could not open certificate: $CERT"
		exit 1
	fi
	openssl x509 -noout -in "$CERT" -pubkey | openssl asn1parse -noout -inform pem -out /tmp/tmp.public.key
	HASH="`openssl dgst -sha256 -binary /tmp/tmp.public.key | openssl enc -base64`"
	rm -f /tmp/tmp.public.key
	if [ "$HASH" = "" ]; then
		echo "Sorry, something went wrong when generating the SPKI fingerprint."
		echo "Is the 'openssl' tool properly installed?"
		exit 1
	fi
	echo "The SPKI fingerprint for certificate $CERT is:"
	echo "$HASH"
	echo ""
	echo "You normally add this password on the other side of the link as:"
	echo "password \"$HASH\" { spkifp; };"
	echo ""
elif [ "$1" = "hot-patch" -o "$1" = "cold-patch" ] ; then
	if [ ! -d "/build/unrealircd/src/unrealircd-5.0.3.1" ]; then
		echo "UnrealIRCd source not found. Sorry, it is not possible to patch."
		exit 1
	fi
	if [ "$2" = "" ]; then
		echo "Argument required: ./unrealircd &lthot-patch|cold-patch&gt &ltname-of-patch&gt"
		exit 1
	fi
	if ! wget --help 1&gt/dev/null 2&gt&1; then
		echo "The tool 'wget' is missing, which is used by this script."
		echo "On Linux consider running 'apt install wget' or a similar command."
		exit 1
	fi
	cd "/build/unrealircd/src/unrealircd-5.0.3.1" || exit 1

	# Weird way to get version, but ok.
	UNREALVER="`./configure --version|head -n1|awk '{ print $3 }'`"
	wget -O patch "https://www.unrealircd.org/patch?type=$1&patch=$2&version=$UNREALVER" || exit 1

	# A patch file of 0 bytes means the patch is not needed
	if [ -f patch -a ! -s patch ]; then
		echo "This UnrealIRCd version does not require that patch"
	fi

	if patch --dry-run -p1 -R &ltpatch 1&gt/dev/null 2&gt&1; then
		echo "Patch already applied. Nothing to do."
		exit 1
	fi

	if ! patch -p1 &ltpatch; then
		echo "Patch failed to apply"
		exit 1
	fi

	echo "Patch applied successfully. Now recompiling..."
	make || gmake || exit 1
	make install || gmake install || exit 1

	cd -
	if [ "$1" = "hot-patch" ]; then
		echo "Patch applied successfully and installed. Rehashing your IRCd..."
		./unrealircd rehash
		echo "Done! All should be good now."
	else
		echo "Patch applied successfully. You must now restart your IRC server."
	fi
elif [ "$1" = "genlinkblock" ] ; then
	/usr/bin/unrealircd -L
else
	if [ "$1" = "" ]; then
		echo "This script expects a parameter. Use:"
	else
		echo "Unrecognized parameter '$1'. Use:"
	fi
	echo "unrealircd configtest    Test the configuration file"
	echo "unrealircd start         Start the IRC Server"
	echo "unrealircd stop          Stop (kill) the IRC Server"
	echo "unrealircd rehash        Reload the configuration file"
	echo "unrealircd reloadtls     Reload the SSL/TLS certificate and settings"
	echo "unrealircd restart       Restart the IRC Server (stop+start)"
	echo "unrealircd mkpasswd      Hash a password"
	echo "unrealircd version       Display the UnrealIRCd version"
	echo "unrealircd module        Install and uninstall 3rd party modules"
	echo "unrealircd croncheck     For use in crontab: this checks if the server"
	echo "                         is running. If not, the server is started."
	echo "unrealircd gencloak      Display 3 random cloak keys"
	echo "unrealircd spkifp        Display SPKI Fingerprint"
	echo "unrealircd upgrade-conf  Upgrade the configuration file from UnrealIRCd"
	echo "                         3.2.x/4.x to 5.x format"
fi
</code>
</pre>

<p> 少しずつ解説する. PIDファイルというのはプロセスの識別子であり, このファイルによってプロセスの状態を確認する. UNIXではevery thing is file という哲学の元, 状態もファイルの形で管理される. if [ ! -f /usr/bin/unrealircd] は/usr/bin/unrealirc というファイルが存在しない時にthen以降が実行される. 
<pre>
<code>
PID_FILE="/run/unrealircd/ircd.pid"
PID_BACKUP="/run/unrealircd/ircd.pid.bak"
if [ ! -f /usr/bin/unrealircd ]; then
	echo "ERROR: Could not find the IRCd binary (/usr/bin/unrealircd)"
	echo "This could mean two things:"
	echo "1) You forgot to run 'make install' after running 'make'"
	echo "2) You answered a ./Config question incorrectly"
	exit
fi
</code>
</pre>

<p>
<pre> $1というのはコマンドの1番目の引数. 引数は0番目から数える. $0は0番目の引数だが, これはunrealircdという実行ファイルの名前自体を指すことになる. if [ -r $PID_FILE ] というのは, ファイルが存在しさらに読み込み権限があるかを判断する. このように[]で囲むものはtestコマンドと呼ばれ, man test とすれば-rオプションが何を意味するかすぐに調べられる. mv -f はすでに同じファイル名のものが存在している時に, 上書きするかのプロンプトを出さずすぐに上書きする. if [ $? -ne 0 ] の $? はプロセスの終了状態を表し, 正常なら0, そうでない場合0以外を返すことになる. 直前に/usr/bin/unrealircdを呼び出しているのでこの実行コマンドに関する終了状態で判定している. (TODO: unrealircd -Rの説明)
<code>
if [ "$1" = "start" ] ; then
	echo "Starting UnrealIRCd"
	if [ -r $PID_FILE ] ; then
		mv -f $PID_FILE $PID_BACKUP
	fi
	# When built with --with-asan, ASan does not dump core by default because
	# older gcc/clang might dump a 16TB core file. We explicitly enable it here.
	export ASAN_OPTIONS="abort_on_error=1:disable_coredump=0:unmap_shadow_on_exit=1:log_path=/tmp/unrealircd_asan:detect_leaks=0"

	# Check if ~/Unrealxxx/unrealircd.conf exists but the file
	# ~/unrealircd/conf/unrealircd.conf does not.
	# If so, then assume a user-build and give the user a nice hint...
	if [ ! -f /etc/unrealircd/unrealircd.conf -a -f /build/unrealircd/src/unrealircd-5.0.3.1/unrealircd.conf ]; then
		echo ""
		echo "There is no unrealircd.conf in /etc/unrealircd"
		echo "However I did find an unrealircd.conf in /build/unrealircd/src/unrealircd-5.0.3.1"
		echo "With UnrealIRCd 4 you should no longer run the IRCd from /build/unrealircd/src/unrealircd-5.0.3.1."
		echo "You should 'cd /usr' and work from there."
		echo "See https://www.unrealircd.org/docs/UnrealIRCd_files_and_directories"
		exit 1
	fi
	if [ ! -f /etc/unrealircd/unrealircd.conf ]; then
		echo ""
		echo "The configuration file does not exist (/etc/unrealircd/unrealircd.conf)."
		echo "* Create one by following:"
		echo "  https://www.unrealircd.org/docs/Installing_from_source#Creating_a_configuration_file"
		echo "* Or if you are upgrading from version 3.2.x then read:"
		echo "  https://www.unrealircd.org/docs/Upgrading_from_3.2.x and"
		echo "  https://www.unrealircd.org/docs/UnrealIRCd_files_and_directories"
		exit 1
	fi
	/usr/bin/unrealircd
	if [ $? -ne 0 ] ; then
		echo "====================================================="
		echo "UnrealIRCd failed to start. Check above for possible errors."
		echo "If you don't understand the problem, then have a look at our:"
		echo "* FAQ (Frequently Asked Questions): https://www.unrealircd.org/docs/FAQ"
		echo "* Documentation: https://www.unrealircd.org/docs/"
		echo "====================================================="
		if [ -r $PID_BACKUP ] ; then
			mv -f $PID_BACKUP $PID_FILE
		fi
		exit 1
	fi
	# Now check if we need to create a crash report.
	/usr/bin/unrealircd -R
</code>
</pre>

<p> kill -n でジグナルnで終了させる.

<table border>
<tr>
<th>シグナル番号</th>
<th>命令</th>
<th>意味</th>
</tr>
<tr>
<td>1</td>
<td>SIGHUP</td>
<td>再起動</td>
</tr>
<tr>
<td>6</td>
<td>SIGABRT</td>
<td>中断</td>
</tr>
<tr>
<td>9</td>
<td>SIGKILL</td> 
<td>強制終了</td>
</tr>
<tr>
<td>15</td>
<td>SIGTERM</td>
<td>終了</td>
</tr>
<tr>
<td>17</td>
<td>SIGSTOP</td>
<td>停止</td>
</tr>
<tr>
<td>18</td>
<td>SIGCONT</td>
<td>再開</td>
</tr>
</table>
<pre>
<code>
elif [ "$1" = "stop" ] ; then
	echo "Stopping UnrealIRCd"
	if [ ! -r $PID_FILE ] ; then
		echo "ERROR: UnrealIRCd is not running"
		exit 1
	fi
	kill -15 `cat $PID_FILE`
	if [ "$?" != 0 ]; then
		echo "ERROR: UnrealIRCd is not running"
		exit 1
	fi
	sleep 1
	if [ -r $PID_FILE ] ; then
		kill -9 `cat $PID_FILE` 1&gt/dev/null 2&gt&1
	fi

</code>
</pre>

<p> rehashは停止したプロセスを再開. このようにまず$PID_FILEの存在を確認してから, シグナルで命令し, 終了状態から正常に動作したかを確認する, という流れが定跡だ.
<pre>
<code>
elif [ "$1" = "rehash" ] ; then
	echo "Rehashing UnrealIRCd"
	if [ ! -r $PID_FILE ] ; then
		echo "ERROR: UnrealIRCd is not running"
		exit 1
	fi
	kill -1 `cat $PID_FILE`
	if [ "$?" != 0 ]; then
		echo "ERROR: UnrealIRCd is not running"
		exit 1
	fi
</code>
</pre>

<p> restartはただstopの動作をしてからstartするだけ. 
<pre>
<code>
elif [ "$1" = "restart" ] ; then
	echo "Restarting UnrealIRCd"
	if [ ! -r $PID_FILE ] ; then
		echo "WARNING: UnrealIRCd was not running"
	else
		kill -15 `cat $PID_FILE`
		if [ "$?" != 0 ]; then
			echo "WARNING: UnrealIRCd was not running"
		else
			sleep 1
			kill -9 `cat $PID_FILE` 1&gt/dev/null 2&gt&1
		fi
	fi
	$0 start
</code>
</pre>

<p> 
<pre>
<code>
elif [ "$1" = "croncheck" ] ; then
	if [ -r $PID_FILE ] ; then
		kill -CHLD `cat $PID_FILE` 1&gt/dev/null 2&gt&1
		if [ "$?" = 0 ]; then
			# IRCd is running, bail out silently.
			exit 0
		fi
	fi
	# PID file not found or found but stale
	echo "UnrealIRCd is not running. Starting now..."
	$0 start
</code>
</pre>
</body>
</html>
/* This file will load (nearly) all modules available on UnrealIRCd.
 * So all commands, channel modes, user modes, etc..
 *
 * If you want to have all UnrealIRCd functionality, then include this
 * file from your unrealircd.conf by using:
 * include "modules.default.conf";
 *
 * DO NOT EDIT THIS FILE! IT WILL BE OVERWRITTEN DURING NEXT UPGRADE!!
 * If you want to customize the modules to load you have two options:
 * 1) Keep the include for modules.default.conf as usual and make use
 *    of blacklist-module "xyz"; to selectively disable modules.
 *    See https://www.unrealircd.org/docs/Blacklist-module_directive
 * 2) OR, make a copy of this file (eg: name it modules.custom.conf)
 *    and edit it. Then include that file from your unrealircd.conf
 *    instead of this one.
 * The downside of option #2 is that you will need to track changes
 * in the original modules.default.conf with each new UnrealIRCd
 * release to make sure you don't miss any new functionality (as new
 * important modules may be added you need to add them to your conf).
 * You don't have this problem with option #1.
 */

/*** Cloaking (for user mode +x) ***/
loadmodule "cloak";


/*** Commands ***/

// User commands (MINIMAL)
// These provide just the minimal set of IRC commands that are
// required by RFC1459 along with WATCH and MAP.
loadmodule "admin";
loadmodule "away";
loadmodule "invite";
loadmodule "ison";
loadmodule "join";
loadmodule "kick";
loadmodule "links";
loadmodule "list";
loadmodule "lusers";
loadmodule "map";
loadmodule "message";
loadmodule "mode";
loadmodule "motd";
loadmodule "names";
loadmodule "nick";
loadmodule "part";
loadmodule "pass";
loadmodule "pingpong";
loadmodule "protoctl";
loadmodule "quit";
loadmodule "rules";
loadmodule "topic";
loadmodule "user";
loadmodule "userhost";
loadmodule "watch";
loadmodule "whox";
loadmodule "whois";
loadmodule "whowas";

// User commands (EXTENDED)
// These are commands that provide extended functionality.
loadmodule "botmotd";
loadmodule "cap";
loadmodule "cycle";
loadmodule "dccallow";
loadmodule "help";
loadmodule "knock";
loadmodule "lag";
loadmodule "sasl";
loadmodule "setname";
loadmodule "silence";
loadmodule "starttls";
loadmodule "time";
loadmodule "userip";
loadmodule "vhost";
loadmodule "history";

// IRC Operator commands
// Note: several of these like kill are also server-to-server commands
// which are required if you link to other servers.
loadmodule "addmotd";
loadmodule "addomotd";
loadmodule "chghost";
loadmodule "chgident";
loadmodule "chgname";
loadmodule "close";
loadmodule "connect";
loadmodule "squit";
loadmodule "dccdeny";
loadmodule "globops";
loadmodule "kill"; /* also server-to-server */
loadmodule "locops";
loadmodule "mkpasswd";
loadmodule "oper";
loadmodule "opermotd";
loadmodule "sajoin";
loadmodule "samode";
loadmodule "sapart";
loadmodule "sdesc";
loadmodule "sethost";
loadmodule "setident";
loadmodule "stats";
loadmodule "tkl"; /* also server-to-server */
loadmodule "trace";
loadmodule "tsctl";
loadmodule "unsqline";
loadmodule "wallops";
loadmodule "jumpserver";

// Server-to-server commands
// Don't remove these, unless you never link to other servers.
loadmodule "eos";
loadmodule "md";
loadmodule "netinfo";
loadmodule "server";
loadmodule "sjoin";
loadmodule "sqline";
loadmodule "swhois";
loadmodule "umode2";
loadmodule "sinfo";
loadmodule "require-module";

// Services commands
// You could disable these if you don't use Services
// https://www.unrealircd.org/docs/Services
loadmodule "sendsno";
loadmodule "sendumode";
loadmodule "svsjoin";
loadmodule "svskill";
loadmodule "svslusers";
loadmodule "svsmode";
loadmodule "svsmotd";
loadmodule "svsnick";
loadmodule "svsnline";
loadmodule "svsnolag";
loadmodule "svsnoop";
loadmodule "svspart";
loadmodule "svssilence";
loadmodule "svssno";
loadmodule "svswatch";


/*** Channel modes ***/
loadmodule "chanmodes/floodprot"; /* +f */
loadmodule "chanmodes/nocolor"; /* +c */
loadmodule "chanmodes/noctcp"; /* +C */
loadmodule "chanmodes/stripcolor"; /* +S */
loadmodule "chanmodes/issecure"; /* +Z */
loadmodule "chanmodes/permanent"; /* +P */
loadmodule "chanmodes/link"; /* +L */
loadmodule "chanmodes/censor"; /* +G */
loadmodule "chanmodes/delayjoin"; /* +D  */
loadmodule "chanmodes/noknock"; /* +K */
loadmodule "chanmodes/noinvite"; /* +V */
loadmodule "chanmodes/operonly"; /* +O */
loadmodule "chanmodes/nonotice"; /* +T */
loadmodule "chanmodes/regonly"; /* +R */
loadmodule "chanmodes/nonickchange"; /* +N */
loadmodule "chanmodes/nokick"; /* +Q */
loadmodule "chanmodes/regonlyspeak"; /* +M */
loadmodule "chanmodes/secureonly"; /* +z */
loadmodule "chanmodes/history"; /* +H */


/*** User modes ***/
loadmodule "usermodes/bot"; /* +B (mark yourself as a bot) */
loadmodule "usermodes/servicebot"; /* +S (service bot) */
loadmodule "usermodes/noctcp"; /* +T (block CTCP's) */
loadmodule "usermodes/censor"; /* +G (censor bad words) */
loadmodule "usermodes/showwhois"; /* +W (show if someone does /WHOIS) */
loadmodule "usermodes/privacy"; /* +p (privacy, hide channels in /WHOIS) */
loadmodule "usermodes/nokick"; /* +q (unkickable oper) */
loadmodule "usermodes/regonlymsg"; /* +R (only registered users may private message you) */
loadmodule "usermodes/secureonlymsg"; /* +Z (only SSL/TLS users may private message you) */
loadmodule "usermodes/privdeaf"; /* +D (don't let other user PM you) */


/*** Server notice masks */
loadmodule "snomasks/dccreject"; /* +D (rejected DCC's) */


/*** Extended Bans ***/
loadmodule "extbans/join"; /* +b ~j (prevent only joins) */
loadmodule "extbans/quiet"; /* +b ~q (prevent only messaging) */
loadmodule "extbans/nickchange"; /* +b ~n (prevent only nick changes) */
loadmodule "extbans/realname"; /* +b ~r (ban by real name) */
loadmodule "extbans/account"; /* +b ~a (ban/exempt if logged in with services account) */
loadmodule "extbans/inchannel"; /* +b ~c (ban/exempt if in channel) */
loadmodule "extbans/operclass"; /* +b ~O (ban/exempt by operclass) */
loadmodule "extbans/certfp"; /* +b ~S (ban/exempt by certfp) */
loadmodule "extbans/textban"; /* +b ~T (censor or block text) */
loadmodule "extbans/msgbypass"; /* +e ~m (bypass message restrictions) */
loadmodule "extbans/timedban"; /* +b ~t (timed bans / temporary bans) */
loadmodule "extbans/partmsg"; /* +b ~p (hide part/quit message) */


/** IRCv3 extensions */
loadmodule "account-notify"; /* send ACCOUNT message upon services account login */
loadmodule "message-tags"; /* add tags to messages, required for various IRCv3 features */
loadmodule "batch"; /* also required for several IRCv3 features */
loadmodule "account-tag"; /* adds services account information to messages */
loadmodule "link-security"; /* link-security announce */
loadmodule "message-ids"; /* adds unique msgid to various messages */
loadmodule "plaintext-policy"; /* plaintext-policy announce */
loadmodule "server-time"; /* adds server timestamp to various messages */
loadmodule "sts"; /* strict transport policy (set::tls::sts-policy) */
loadmodule "echo-message"; /* shows clients if their messages are altered/filtered */
loadmodule "labeled-response"; /* correlate requests and responses easily */


/*** Other ***/
// These are modules that don't fit in any of the previous sections
loadmodule "ident_lookup"; /* Ident lookups if set::options::identd-check is set*/
loadmodule "certfp"; /* SSL/TLS certificate fingerprint in /WHOIS (& more) */
loadmodule "tls_antidos"; /* prevent TLS DoS (renegotiate floods) */
loadmodule "webirc"; /* WEBIRC command. See webirc block. */
loadmodule "blacklist"; /* Blacklist support (DNSBL). See blacklist block. */
loadmodule "jointhrottle"; /* set::anti-flood::join-flood (previously chanmode +j) */
loadmodule "charsys"; /* Provides set::allowed-nickchars (must always be loaded!) */
loadmodule "authprompt"; /* Authentication prompt, see set::authentication-prompt */
loadmodule "history_backend_mem"; /* History storage backend (used by chanmodes/history) */
loadmodule "tkldb"; /* Write TKLines to .db file */
loadmodule "channeldb"; /* Write channel settings to .db file (+P channels only) */
loadmodule "rmtkl"; /* Easily remove *-Lines in bulk with /RMTKL */
loadmodule "restrict-commands"; /* Provides set::restrict-commands settings */
loadmodule "reputation"; /* used by Connthrottle and others, see next */
loadmodule "connthrottle"; /* see https://www.unrealircd.org/docs/Connthrottle */
loadmodule "userip-tag"; /* unrealircd.org/userip-tag for ircops */
loadmodule "userhost-tag"; /* unrealircd.org/userhost-tag for ircops */
